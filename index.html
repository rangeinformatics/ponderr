<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Admission Register</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 10px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid #000;
      padding-bottom: 5px;
    }
    header .school-info {
      text-align: center;
      flex: 1;
    }
    header img {
      height: 50px;
      width: 50px;
      object-fit: contain;
    }
    .controls {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #000;
      padding: 3px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      font-size: 11px;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      font-size: 11px;
    }
    .btn {
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }
    @media print {
      @page {
        size: A4 landscape;
        margin: 10mm;
      }
      .no-print {
        display: none !important;
      }
      body {
        margin: 0;
      }
    }
  </style>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div style="width:60px;">
      <!-- Replace src with actual logo -->
      <img src="" alt="Logo" />
    </div>
    <div class="school-info">
      <div><strong id="schoolNameHeader">School Name</strong></div>
      <div>Academic Year: <span id="academicYearLabel">2026-27</span></div>
      <div><strong>Admission Register – Student List</strong></div>
    </div>
    <div style="width:60px;"></div>
  </header>

  <div class="controls no-print">
    <label>
      <strong>School:</strong>
      <select id="schoolSelect">
        <option value="Little Angels School">Little Angels School</option>
        <option value="MAM School">MAM School</option>
        <!-- Add more schools here -->
      </select>
    </label>
    <label>
      <strong>Academic Year:</strong>
      <input type="text" id="academicYearInput" value="2026-27" />
    </label>
    <button class="btn" onclick="addRow()">Add Row</button>
    <button class="btn" onclick="saveCurrentSchool()">Save</button>
    <button class="btn" onclick="printPage()">Print</button>
    <button class="btn" onclick="exportAllSchoolsToExcel()">Export All Schools to Excel</button>
  </div>

  <table id="studentTable">
    <thead>
      <tr>
        <th>Sl. No</th>
        <th>Admission No / UID</th>
        <th>Student Name</th>
        <th>Father / Mother / Guardian Name</th>
        <th>Mobile Number</th>
        <th>Present – Admitted? (Y/N)</th>
        <th>Present Grade</th>
        <th>Previous Schooling? (Y/N)</th>
        <th>Previous Grade</th>
        <th>Eng</th>
        <th>Kan</th>
        <th>Hin</th>
        <th>Sci</th>
        <th>Maths</th>
        <th>Soc/EVS</th>
        <th>Sports</th>
        <th>Coding</th>
        <th>Remarks</th>
        <th>Signature</th>
      </tr>
    </thead>
    <tbody id="studentTableBody">
    </tbody>
  </table>

  <script>
    const PRESENT_GRADES = [
      "LKG","UKG",
      "Grade 1","Grade 2","Grade 3","Grade 4","Grade 5",
      "Grade 6","Grade 7","Grade 8","Grade 9","Grade 10"
    ];
    const PREVIOUS_GRADES = [
      "Nursery","LKG","UKG",
      "Grade 1","Grade 2","Grade 3","Grade 4","Grade 5",
      "Grade 6","Grade 7","Grade 8","Grade 9","Grade 10"
    ];
    const RESULT_OPTIONS = ["Passed","Failed","Average"];
    const STORAGE_KEY = "schoolStudentLists_v1";

    let allSchoolData = {}; // { [schoolName]: [rows] }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          allSchoolData = JSON.parse(raw);
        } catch (e) {
          allSchoolData = {};
        }
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allSchoolData));
    }

    function getCurrentSchoolName() {
      return document.getElementById("schoolSelect").value;
    }

    function syncHeader() {
      const schoolName = getCurrentSchoolName();
      document.getElementById("schoolNameHeader").textContent = schoolName;
      const ay = document.getElementById("academicYearInput").value;
      document.getElementById("academicYearLabel").textContent = ay;
    }

    function createSelect(options, includeEmpty = true) {
      const sel = document.createElement("select");
      if (includeEmpty) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "";
        sel.appendChild(opt);
      }
      options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        sel.appendChild(opt);
      });
      return sel;
    }

    function addRow(rowData = null) {
      const tbody = document.getElementById("studentTableBody");
      const tr = document.createElement("tr");
      const rowIndex = tbody.children.length + 1;

      function tdWithInput(value = "") {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.value = value || "";
        td.appendChild(input);
        return td;
      }

      // Sl. No (read-only)
      const tdSl = document.createElement("td");
      tdSl.textContent = rowIndex;
      tr.appendChild(tdSl);

      // Admission No / UID
      tr.appendChild(tdWithInput(rowData?.admissionNo));

      // Student Name
      tr.appendChild(tdWithInput(rowData?.studentName));

      // Guardian Name
      tr.appendChild(tdWithInput(rowData?.guardianName));

      // Mobile
      tr.appendChild(tdWithInput(rowData?.mobile));

      // Present – Admitted? (Y/N)
      const tdPresent = document.createElement("td");
      const selPresent = createSelect(["Yes","No"]);
      selPresent.value = rowData?.presentAdmitted || "";
      tdPresent.appendChild(selPresent);
      tr.appendChild(tdPresent);

      // Present Grade
      const tdPresentGrade = document.createElement("td");
      const selPresentGrade = createSelect(PRESENT_GRADES);
      selPresentGrade.value = rowData?.presentGrade || "";
      tdPresentGrade.appendChild(selPresentGrade);
      tr.appendChild(tdPresentGrade);

      // Previous Schooling? (Y/N)
      const tdPrevSchooling = document.createElement("td");
      const selPrevSchooling = createSelect(["Yes","No"]);
      selPrevSchooling.value = rowData?.previousSchooling || "";
      tdPrevSchooling.appendChild(selPrevSchooling);
      tr.appendChild(tdPrevSchooling);

      // Previous Grade
      const tdPrevGrade = document.createElement("td");
      const selPrevGrade = createSelect(PREVIOUS_GRADES);
      selPrevGrade.value = rowData?.previousGrade || "";
      tdPrevGrade.appendChild(selPrevGrade);
      tr.appendChild(tdPrevGrade);

      // Entrance Test Results (8 subjects)
      const subjects = ["eng","kan","hin","sci","maths","soc","sports","coding"];
      subjects.forEach(sub => {
        const td = document.createElement("td");
        const sel = createSelect(RESULT_OPTIONS);
        sel.value = rowData?.results?.[sub] || "";
        td.appendChild(sel);
        tr.appendChild(td);
      });

      // Remarks
      tr.appendChild(tdWithInput(rowData?.remarks));

      // Signature
      tr.appendChild(tdWithInput(rowData?.signature));

      // Logic: auto previous grade when present grade changes
      selPresentGrade.addEventListener("change", () => {
        autoSetPreviousGrade(selPresentGrade, selPrevGrade);
      });

      tbody.appendChild(tr);
    }

    function autoSetPreviousGrade(selPresentGrade, selPrevGrade) {
      const pg = selPresentGrade.value;
      if (!pg) return;
      const order = PREVIOUS_GRADES;
      // Map present grade to previous grade
      let target;
      if (pg === "LKG") target = "Nursery";
      else if (pg === "UKG") target = "LKG";
      else {
        const idx = order.indexOf(pg);
        if (idx > 0) target = order[idx - 1];
      }
      if (target) selPrevGrade.value = target;
    }

    function clearTable() {
      document.getElementById("studentTableBody").innerHTML = "";
    }

    function loadSchoolIntoTable(schoolName) {
      syncHeader();
      clearTable();
      const rows = allSchoolData[schoolName] || [];
      if (rows.length === 0) {
        // Start with a few empty rows
        for (let i = 0; i < 5; i++) addRow();
      } else {
        rows.forEach(r => addRow(r));
      }
    }

    function collectCurrentTableData() {
      const tbody = document.getElementById("studentTableBody");
      const rows = [];
      for (let i = 0; i < tbody.children.length; i++) {
        const tr = tbody.children[i];
        const tds = tr.children;

        const getInputValue = (tdIndex) =>
          tds[tdIndex].querySelector("input")?.value || "";
        const getSelectValue = (tdIndex) =>
          tds[tdIndex].querySelector("select")?.value || "";

        const row = {
          admissionNo: getInputValue(1),
          studentName: getInputValue(2),
          guardianName: getInputValue(3),
          mobile: getInputValue(4),
          presentAdmitted: getSelectValue(5),
          presentGrade: getSelectValue(6),
          previousSchooling: getSelectValue(7),
          previousGrade: getSelectValue(8),
          results: {
            eng: getSelectValue(9),
            kan: getSelectValue(10),
            hin: getSelectValue(11),
            sci: getSelectValue(12),
            maths: getSelectValue(13),
            soc: getSelectValue(14),
            sports: getSelectValue(15),
            coding: getSelectValue(16),
          },
          remarks: getInputValue(17),
          signature: getInputValue(18),
        };
        rows.push(row);
      }
      return rows;
    }

    function saveCurrentSchool() {
      const schoolName = getCurrentSchoolName();
      const rows = collectCurrentTableData();
      allSchoolData[schoolName] = rows;
      saveToStorage();
      alert("Saved for " + schoolName);
    }

    function printPage() {
      syncHeader();
      window.print();
    }

    function exportAllSchoolsToExcel() {
      const wb = XLSX.utils.book_new();

      Object.keys(allSchoolData).forEach((schoolName) => {
        const rows = allSchoolData[schoolName] || [];
        const data = [];

        // Header row
        data.push([
          "Sl. No",
          "Admission No / UID",
          "Student Name",
          "Father/Mother/Guardian",
          "Mobile",
          "Present Admitted",
          "Present Grade",
          "Previous Schooling",
          "Previous Grade",
          "English",
          "Kannada",
          "Hindi",
          "Science",
          "Maths",
          "Social/EVS",
          "Sports",
          "Coding",
          "Remarks",
          "Signature"
        ]);

        rows.forEach((r, idx) => {
          data.push([
            idx + 1,
            r.admissionNo,
            r.studentName,
            r.guardianName,
            r.mobile,
            r.presentAdmitted,
            r.presentGrade,
            r.previousSchooling,
            r.previousGrade,
            r.results.eng,
            r.results.kan,
            r.results.hin,
            r.results.sci,
            r.results.maths,
            r.results.soc,
            r.results.sports,
            r.results.coding,
            r.remarks,
            r.signature
          ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, schoolName.substring(0, 31));
      });

      const ay = document.getElementById("academicYearInput").value || "AY";
      XLSX.writeFile(wb, `Student_Admission_Register_${ay}.xlsx`);
    }

    document.getElementById("schoolSelect").addEventListener("change", () => {
      const schoolName = getCurrentSchoolName();
      loadSchoolIntoTable(schoolName);
    });

    document.getElementById("academicYearInput").addEventListener("input", syncHeader);

    // Init
    loadFromStorage();
    loadSchoolIntoTable(getCurrentSchoolName());
  </script>
</body>
</html>
